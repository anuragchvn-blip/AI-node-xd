generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
  extensions = [vector]
}

model Organization {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String    @db.VarChar(255)
  creditsBalance Int       @default(5) @map("credits_balance")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  projects       Project[]
  transactions   Transaction[]

  @@map("organizations")
}

model Project {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  apiKey    String   @unique @map("api_key") @db.VarChar(255)
  repoUrl   String?  @map("repo_url") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  organization     Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  failurePatterns  FailurePattern[]
  usageLogs        UsageLog[]

  @@map("projects")
}

model FailurePattern {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId       String   @map("project_id") @db.Uuid
  embedding       Unsupported("vector(1536)")?
  summary         String   @db.Text
  errorMessage    String   @map("error_message") @db.Text
  stackTrace      String?  @map("stack_trace") @db.Text
  affectedFiles   String[] @map("affected_files")
  testName        String?  @map("test_name") @db.VarChar(500)
  occurrenceCount Int      @default(1) @map("occurrence_count")
  firstSeen       DateTime @default(now()) @map("first_seen") @db.Timestamptz(6)
  lastSeen        DateTime @default(now()) @map("last_seen") @db.Timestamptz(6)
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("failure_patterns")
}

model Transaction {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId              String   @map("org_id") @db.Uuid
  razorpayOrderId    String?  @unique @map("razorpay_order_id") @db.VarChar(255)
  razorpayPaymentId  String?  @map("razorpay_payment_id") @db.VarChar(255)
  amount             Int
  creditsAdded       Int      @map("credits_added")
  status             String   @default("pending") @db.VarChar(50)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  organization Organization @relation(fields: [orgId], references: [id])

  @@map("transactions")
}

model UsageLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  actionType String   @map("action_type") @db.VarChar(50)
  cost       Int      @default(1)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  project Project @relation(fields: [projectId], references: [id])

  @@map("usage_logs")
}
